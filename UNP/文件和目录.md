# 文件和目录

## stat及其相关函数

* fstat函数获得的是对应文件描述符的打开文件的信息
* 当一个文件是符号链接时，lstat 函数返回的是该符号链接本身的信息；而 stat 函数返回的是该链接指向文件的信息。
* fstatat函数为一个相对于目录（由fd参数指定，AT_FDCWD表明相对于当前目录）的路径名返回文件结构信息。flag参数控制是否跟随符号链接，当AT_SYMLINK_NOFOLLOW标志被设置时，不会跟随符号链接，返回符号链接本身的信息。默认情况下返回的是符号链接所指向的实际文件的信息。

```c
#include <sys/stat.h>
int stat(const char *path, struct stat *buf);
int fstat(int fd, struct stat *buf);
int lstat(const char *path, struct stat *buf);
int fstatat(int fd, const char *path,struct stat *buf, int flag );
//成功返回0，出错返回-1

struct stat {
    mode_t              st_mode;       //文件对应的模式，文件，目录等
    ino_t               st_ino;        //inode节点号
    dev_t               st_dev;        //设备号码
    dev_t               st_rdev;       //特殊设备号码
    nlink_t             st_nlink;      //文件的连接数
    uid_t               st_uid;        //文件所有者
    gid_t               st_gid;        //文件所有者对应的组
    off_t               st_size;       //普通文件，对应的文件字节数
    struct timespec     st_atime;      //文件最后被访问的时间
    struct timespec     st_mtime;      //文件内容最后被修改的时间
    struct timespec     st_ctime;      //文件状态改变时间
    blksize_t           st_blksize;    //文件内容对应的块大小
    blkcnt_t            st_blocks;     //文件内容对应的块数量
};
struct timespec{
    time_t tv_sec; //秒
    long tv_nsec;  //纳秒
};
```

## 文件类型介绍

1. 普通文件，S_ISREG()
2. 目录文件, S_ISDIR()
3. 块特殊文件。S_ISCHR(),提供对设备带缓冲的访问，每次访问以固定长度为单位进行
4. 字符特殊文件，S_ISBLK(),提供对设备不带缓冲的访问，每次访问长度可变
5. FIFO，命名管道,S_ISFIFO()
6. 套接字，主要用于网络通信,S_ISSOCK()
7. 符号链接,S_ISLINK()

* 对stat结构中的st_mode用宏判断，可以得到对应的文件类型
* 对指向stat的指针用下列宏，可以判断进程间通信的对象，对这些对象的详细介绍见
  * S_TYPEISMQ()，消息队列
  * S_TYPEISSEM()， 信号量
  * S_TYPEISSHM()，共享存储对象

## 用户ID和组ID

* 实际用户ID和实际组ID, 标识我们是谁，取自口令文件中的登录项
* 有效用户ID,有效组ID，附属组ID，控制文件访问权限
* 保存的设置用户ID和保存的设置组ID，在执行一个程序时包含了有效用户ID和有效组ID的副本
* 每个文件都有一个所有者和组所有者，由stat结构中的st_uid和st_gid指定
* 每个进程通常有效用户ID就是实际用户ID，有效组ID就是实际组ID。但是在文件的st_mode中，可以设置一个设置用户ID位，表示“当执行此文件时，将进程的有效用户ID设置成文件所有者的用户ID”,还有类似的设置组ID位。这两位可用宏S_ISUID和S_ISGID测试。

### access和faccessat函数

### 更改文件用户ID和组ID

## 文件访问权限

* 每个文件有9个访问权限位，用户USR/组GRP/其他OTH 读IR/写IW/执行IX 组合而成，用宏S_IRUSR等判断
* 对目录的特殊规则
  * 目录的读权限只允许获得在该目录中所有文件名的列表，只有可执行权限才能通过该目录，因此打开任一类型的文件时，对路径中包含的每一个目录，都要有可执行的权限
  * 在目录中创建一个新文件，需要有该目录的写权限和执行权限
  * 删除一个文件，必须对包含该文件的目录具有写权限和执行权限，对文件本身不需要什么权限
* 判断进程对文件拥有的权限，按以下的先后顺序判断
  * 进程的有效用户是0(超级用户)，则允许访问
  * 进程的有效用户ID等于文件的所有者ID，如果所有者适当的访问权限位被设置，则允许访问
  * 有效组ID或附属组ID等于文件组ID，获得组的访问权限
  * 获得其他用户的访问权限
* 用open或create创建的新文件和目录的ID
 * 新文件的用户ID设置位进程的有效用户ID
 * 组ID可以是进程的有效组ID，也可以是它所在目录的组的ID，默认情况下，如果新文件所在的目录的设置组ID位被设置，则新文件的设置位目录的组ID，否则设置为进程的有效组ID

### umask函数


### chmod, fchmod和fchamodat

